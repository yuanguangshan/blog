---
title: 折腾 openwrt
date: 2023-09-15T19:24:14+08:00
categories: [收藏]
tags: [精品]
---

零、序

我就是太能折腾，太能作妖了，前两天看上了iStore的固件，于是把家里的openwrt重装了一下，这一折腾就是一个周末，iStore固件的安装很简单，但是安装好后发现这个固件没有预置IPsec的服务，这直接导致很多不想暴露给公网的应用要连vpn回家使用的这个场景无法实现，安装IPsec Server的ipk后导致内核崩溃报错，折腾一圈发现GitHub大佬也知道这个问题，最后决定再继续用之前用过的大佬编译好的固件……

嗨，瞎折腾……

一、硬件&网络环境&需求分析

之前通过Esxi安装openwrt后，经常性出现网卡驱动不存在，重启直接失联。考虑到家里的网络环境还是要稳定，all in one一旦挂了就是all boom。每天断网这件事儿一个人无所谓，家里有个老婆是要骂人的。

另外考虑到家里还有HAOS的全屋智能也需要稳定的运行环境，产品狗真的是懒得研究和折腾Esxi或者PVE调优，最终决定openwrt直接刷写到nvme硬盘，单一物理机跑软路由；

all in one真的就是个折腾过程玩的东西，迟早会各干各的活儿。

最终方案：

网络方案使用光猫桥接，N5105+32G的物理机PPPoE拨号，不使用旁路由
软路由做科学环境
软路由处理DDNS解析公网IP到对应域名
一部分如Nginx，bark推送服务等通过docker安装在openwrt下
二、安装

1、基本配置

1）修改后台地址

从恩山论坛上找了一个大佬编译好的openwrt5.15的包，这个包的默认IP地址并不是我常用的地址；所以刷写好固件之后的第一件事儿就是修改后台地址。

把软路由连接上显示器，连接上键盘，在命令行里输入

vim /etc/config/network
修改其中lan口的IP地址，并且在这里可以看到多口路由器的时候lan口绑定的是哪个物理网口。



1

修改好后，使用

:wq
命令退出vim，重启软路由

reboot
2）修改wan设置，联网；

网线连好LAN口和电脑，通过修改好的IP地址进入路由器后台（如果进不去，需要手动修改以太网的DHCP和默认网关，并确认网线连接的是之前修改network的对应的eth网口）。

进入后台在左侧菜单栏的网络-接口-WAN-物理设置里，对WAN口绑定的实际物理网口进行绑定。



2

绑定好后，选择基本设置，切换协议为PPPOE（需要提前联系网络运营商把光猫改为桥接，如果是光猫拨号，正常选择DHCP也可），在用户名和密码处输入网络运营商提供的账号和密码，保存并应用后，理论上现在即可上网了。



3

2、硬盘扩容

正常的openwrt刷写好固件后，无论硬盘或者SD卡多大，overlay的空间都小的可怜（自己编译固件给出超大预置空间的除外），网上给出的扩容教程非常多且杂，几番试验后找到了一个最适合我的。转载记录下。

1）开放SSH权限

理论上openwrt应该默认开放了ssh权限，登陆用户名与密码同后台登陆

ssh root@192.168.1.1
接下来的后续操作，均在term终端执行。



4

2）更新软件包

opkg update
受镜像源的影响，可能存在部分软件包更新失败，如果不影响后续的操作，忽视即可。



5

3）安装cfdisk，fdisk

opkg install cfdisk
opkg install fdisk
图中我已安装过，再次安装即为更新操作，正常情况下未出现error等字眼即可。



6

4）查询根目录挂载位置

df -h
正常情况下，存在红框里的根目录/挂载在overlayfs地址上即可，图中我已进行过相关操作，所以磁盘容量已经是扩容完毕的了。



7

5）查询硬盘挂载点

这里是往上绝大多数教程的一个深坑，我安装openwrt的物理环境是直接装到了NVME的SSD里，按照往上的教程绝大多数都是直接使用cfdisk命令进行分区，但会进行报错，如果同样使用了nvme的SSD进行安装的，首先需要使用命令进行 硬盘挂载点的查询

fdisk -l
如图红框所示，硬盘挂载在/dev/nvme0n1，容量是232.89G，型号是三星的EVO970 Plus 250G的盘。



8

6）对硬盘进行分区

cfdisk /dev/nvme0n1
执行命令后会进入分区工具的界面，下图源网络，上下键选择至Free Space进行分区，左右键选择至[New]进行新建分区，点击后选择[Write]进行写入，会提示输入yes执行。输入完成后选择[Quit]退出分区工具。



9

7）查看新分区并格式化

fdisk -l
理论上会出现Type为Linux filesystem的一个新的分区，记下device的位置，后边要用，如我图中的/dev/nvme0n1p4就是这个新建分区的位置。



10

使用命令行对这个新的分区进行格式化，在这一步需要谨慎操作，不要选错成其他分区！下图源网络

mkfs.ext4 /dev/nvme0n1p4


11

8）新建目录并挂载

在mnt目录下创建一个新的文件夹名为expansion_space用以做原有overlay分区的数据的迁移，这一步执行完如果没有报错的话不会有任何提示。

mkdir /mnt/expansion_space
查看mnt目录下是否创建成功，下图源网络

ls -alh /mnt


12

使用mount命令挂载分区到新建的目录上，这一步执行完如果没有报错的话不会有任何提示。

mount /dev/nvme0n1p3 /mnt/expansion_space/
查看下挂载完的分区下的文件以检查是否挂在成功，下图源网络

ls -alh /mnt/expansion_space/
出现lost+found目录即为挂载成功



13

9）迁移overlay分区

查看原有overlay下的文件

ls /overlay
使用cp命令复制overlay下的所有文件到新的目录

cp -r /overlay/* /mnt/expansion_space/
查看新目录文件

ls /mnt/expansion_space/
如果结果是本节第一部查看到的overlay下的所有目录，加一个lost+found目录，即为迁移成功。

10）web操作挂载

以下操作在openwrt后台操作，左侧菜单栏选择系统-挂载点，下滑页面找到挂载点，点击添加按钮。



14

选择启用挂载点，在UUID选项卡里选择新创建的分区，可以通过容量大小区分是否为想要的那个分区，挂载点选择作为外部overlay使用，一路保存并使用，下图源网络。



15

本节全部操作完后，重启软路由。

11）查看效果

重启后通过SSH登录到后台，重复第四步的操作，查看到overlay的容量变大就对了。

df -h
参考资料：

搬运 eSir大神的 openwrt系统下/overlay分区扩容方法
​www.bilibili.com/read/cv17550351/

3、良好的网络环境

涉及到hello world、passwall、openclash等等科学工具，避免被喝茶，不讲了，操作流程都大同小异。

4、外网访问

因为家里有联通的公网IP，所以只需要把域名DDNS到公网ip上就可以了，这样即使软路由重新拨号导致公网ip变动，也可以通过域名访问到。

配合防火墙的端口转发，即可实现外网访问内网服务的诉求。

对于无公网ip，借用frp的解决方案，参见

blog去除自定义端口小尾巴
​www.pdkim.fun/3724994c8d03/#%E4%B8%89%E3%80%81%E8%BD%BB%E9%87%8F%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85frp

1）阿里DDNS

后台打开服务-阿里DDNS（不同固件可能位置不一样），按照图中填写即可。

涉及到阿里云的access key和access secret在阿里云进行申请。

如域名服务商是其他地方买的，比如godaddy、腾讯云等等，请自行通过动态DNS配置。



16

2）vpn配置

有一些应用并不常用，且暴露到公网的风险较高，于是采用vpn的方式进入内网环境访问即可，这里使用的是ipsec server的配置。

在后台里找到IPsec VPN服务器选项，填入对应信息。之后即可通过iPhone/Android/Mac/Windows（未试验过）原生客户端可以连接到软路由的同网络环境。



17

3）防火墙端口转发

家里其他的需要暴露的服务，如homeassistant、群晖、jellyfin等等因为是独立的硬件在跑，不会受到openwrt的重装而受影响，但每次openwrt重装之后都需要重新放开端口，这就很麻烦了……

于是想到了一个办法，把firewall配置文件down到本地，常用的端口转发配置好了之后每次重装只需要本地把配置文件写回去就好了。

a.直接修改后台防火墙

b.开启FTP

在openwrt后台开启FTP，启用本地用户，增加根目录为/即可。

安装transmit（mac），通过ip地址和后台登陆的账号密码即可登陆进去。



18

c.修改firewall配置

正常登陆好之后，可以在etc/config/目录下找到firewall文件，通过transmit下载到本地后，使用sublimetext（记事本）打开，打开后将已经配置好的参数复制到配置文件的最后，保存，再上传回openwrt即可。



19

为了防止出现问题，请勿随意对已经存在的数据进行修改



20

4、和智能家居的联动

接下来做一些和智能家居的联动，以及一些强迫症的问题；

1）DHCP顺序发放IP

openwrt默认会将连接进来的设备的IP地址随机发放，这就很让人不舒适了。

在后台的网络-接口-WAN-基本设置里，设置启动和客户数。

如图设置为启动50，客户数100，意思就是我的软路由只允许100个设备连接到这个路由进行上网，并且他们的IP地址只会发放50到255之间。



21

接下来，在DHCP的高级设置，开启顺序分配IP，这样后续在连接到这个软路由的设备的IP就会顺序递增发放了。



25

2）静态IP绑定

homeassistant下边有关小米的一部分IoT设备有一个很奇葩的规定，根据IoT设备的WiFi的IP进行局域网控制，比如飞利浦的那个吸顶灯。（不得不说，在这一点上，localTUYA和易微联的集成就很良心，设备的IP地址更新后，重新HA就会基于新的IP做控制，而且也是本地控制。小米IoT的集成，讲的是云控制，变了IP也不进行更新……）

如果不对这个灯进行mac地址和IP的绑定，那么一旦断网断电超过一定的时间（按照DHCP的租期定），再重新来电后灯的IP变更了，这个设备就不能通过homeassistant控制了……

a.直接在后台绑定

b.修改DHCP配置

同样的，一条一条的配置静态IP和MAC地址绑定太揪心了。

在使用transmit通过FTP连接到openwrt后，在etc/config/目录下找到dhcp文件，下载到本地。

使用sublimetext（记事本）打开，打开后将已经配置好的参数复制到配置文件的最后，保存，再上传回openwrt即可。



22

为了防止出现问题，请勿随意对已经存在的数据进行修改



23

3）群晖的域名劫持

群晖有一宝，叫做QuickConnect，可以在外网和内网用同一个域名访问。黑裙也可以搞一个fastconnect嘛。

黑群晖远程访问及内网自动切换
​www.pdkim.fun/bb71638bb0a7/

在DHCP的设置里，通过自定义挟持域名，讲外网访问的域名劫持到内网群晖的地址，这样即可实现同一个域名，在内网访问时等同于使用了内网IP地址访问，即可提升速度。



24

5、一些舒适性提升的软件

1）iStore安装全能推送PushBot

通过iStore安装全能推送pushbot，可以实现openwrt的乱七八糟的状态自定义推送至iPhone的设备上。

三、docker安装

通过备份好的docker run命令，依次安装如下docker

Portainer-ce版容器管理
filebrowser文件管理器
NPM反向代理管理器
homer个人导航页
subconverter
Bitwarden密码管理器
Bark消息推送器
四、尾

从最早期的极路由刷openwrt系统，到后边用Esxi装 all in on，再到直接买N5105的四口工控机，对于安装openwrt我现在真的是颇有心得。

虽然安装轻车熟路，但是每次需要把镜像刷到硬盘里的这个步骤，对于软路由塞到弱电柜里的胖子来讲，每一次都是来自肉体的折磨，而且nginx-proxy-manager这个docker我到现在也没有找到备份的方法，以及bark每次重新安装都会重新生成一个独立的key，重新配置的成本也很高；

最后一次装完之后，关机断电，拆掉硬盘，通过DiskGenius将硬盘连分区带配置全部备份到电脑里，经过验证，再次重装的时候我只需要刷写硬盘备份回去，立刻就拯救好了